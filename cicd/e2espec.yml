version: 0.2

env:
  parameter-store:
    JWT_SECRET: /mentorpal/v2/shared/jwt_secret
    S3_STATIC_ARN: /mentorpal/v2/s3_static_arn
  # the rest can safely be hard-coded:
  variables:
    LOG_LEVEL: DEBUG
    STAGE: qa
    IS_SENTRY_ENABLED: false
    PYTHON_ENV: careerfair-qa
    REGION: us-east-1
    GRAPHQL_ENDPOINT: https://api.qamentorpal.org/graphql/graphql
    UPLOAD_ENDPOINT: https://api.qamentorpal.org/upload
    STATIC_URL_BASE: https://static-v2.mentorpal.org/
    JOBS_TABLE_NAME: upload-jobs-qa
    FFMPEG_EXECUTABLE: /opt/ffmpeg/ffmpeg
    TRANSCRIBE_INPUT_BUCKET: 'mentorpal-upload-sm-transcribe-input-qa'
    TRANSCRIBE_OUTPUT_BUCKET: 'mentorpal-upload-sm-transcribe-output-qa'
    SIGNED_UPLOAD_BUCKET: 'mentorpal-upload-sm-signed-upload-qa'

phases:
  install:
    runtime-versions:
      nodejs: 14

  pre_build:
    commands:
      - n 16 # workaround https://github.com/aws/aws-codebuild-docker-images/issues/490
      - pyenv global $PYTHON_38_VERSION
      - python3 -m venv /root/venv
      - . /root/venv/bin/activate
      # these are required to run tests
      - pip3 install -r requirements.txt
      - pip3 install -r requirements-test.txt

  build:
    commands:
      - echo running integration tests against deployed qa api
      - make test-integration
